@tailwind base;
@tailwind components;
@tailwind utilities;

/* ====== Тема ====== */

:root {
    --bg: #0a111d;
    --card: #121e24;
    --text: #e5edff;
    --muted: #9bb0d3;
    --accent: #3c73ff;
    /* геометрия HUD */
    --hud-top: calc(env(safe-area-inset-top) + 42px);
    /* отступ от верха Telegram */
    --hud-h: 96px;
    /* ВЫСОТА HUD — как просил */
    --z-hud: 40;
    --z-top-sheet: 70;
    --z-bottom-sheet: 80;
    --ai-greet-h: 56px;
}

html,
body {
    touch-action: pan-x pan-y;
}

html,
body,
#root {
    height: 100%;
    /* чтобы скролл был у внутреннего контейнера, а не у body */
    overflow: hidden;
}

body {
    background: var(--bg);
    color: var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'Apple Color Emoji', 'Segoe UI Emoji';
}


/* ====== Компоненты ====== */

.card {
    @apply rounded-4xl p-5 bg-[var(--card)] border border-white/5;
    box-shadow: 0 6px 30px rgba(0, 0, 0, 0.25);
}

.btn {
    @apply rounded-3xl px-5 py-4 font-semibold transition;
    background: #3c73ff;
}

.btn:active {
    transform: scale(0.98);
}

.btn-outline {
    @apply rounded-3xl px-5 py-4 font-semibold border border-white/10 backdrop-blur;
    background: rgba(255, 255, 255, 0.04);
}

.badge {
    @apply inline-flex items-center gap-2 rounded-2xl px-3 py-1 text-xs border border-white/10 bg-white/5;
}

.skill {
    @apply relative rounded-4xl p-4 border border-white/5 bg-white/5 backdrop-blur;
}


/* ====== Анимации ====== */

.fade-in {
    animation: fadeIn 400ms ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(6px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}


/* ====== Безопасные зоны / HUD ====== */

.hud-fixed {
    position: fixed;
    top: var(--hud-top);
    /* ← обратно к безопасному отступу */
    left: 0;
    right: 0;
    z-index: var(--z-hud);
    background: var(--bg);
    /* чтобы ::before было под контентом */
    position: fixed;
}


/* заливка фоном от самого верха до низа HUD */

.hud-fixed::before {
    content: "";
    position: absolute;
    left: 0;
    right: 0;
    top: calc(-1 * var(--hud-top));
    /* тянем фон вверх до 0 */
    bottom: -30px;
    /* и до нижней кромки HUD */
    background: var(--bg);
    z-index: -1;
    /* под контентом HUD */
}

/* Компактный вариант HUD — подложка заканчивается сразу под контентом */
.hud-fixed.hud-compact::before {
    bottom: 0;
}

/* Градиентная заливка только выше баннера: сверху → фиолетовый → ниже — обычный фон */
.hud-fixed.hud-top-gradient::before {
    background: linear-gradient(180deg, #3c73ff 0%, #7c3aed 65%, var(--bg) 65%);
}

.hud-stick {
    position: sticky;
    top: var(--hud-top);
    z-index: 40;
}


/* даём месту контенту (ниже фикс-HUD и плавающей кнопки тем) */

.safe-top {
    padding-top: calc(var(--hud-top) + var(--hud-h) + 12px);
}


/* На странице AI верхний отступ меньше: только системная область */

.ai-top {
    padding-top: calc(env(safe-area-inset-top) + 8px) !important;
}

.safe-bottom {
    padding-bottom: max(env(safe-area-inset-bottom), 92px);
}


/* ====== Скролл только по вертикали ====== */

html,
body,
#root {
    overflow-x: hidden;
}

.main-scroll {
    height: 100%;
    overflow-y: auto;
    touch-action: pan-y;
    overscroll-behavior-x: none;
    /* скрыть вертикальную полосу прокрутки, сохранив скролл */
    -ms-overflow-style: none; /* IE/Edge */
    scrollbar-width: none;     /* Firefox */
}
.main-scroll::-webkit-scrollbar { /* Chrome/Safari */
    display: none;
}


/* ====== Плавающая кнопка выбора темы ====== */


/* позицию считаем от HUD — гарантированно ниже и кликабельна */

.topics-pin {
    position: fixed;
    top: calc(var(--hud-top) + var(--hud-h) + 8px);
    left: 50%;
    transform: translateX(-50%);
    z-index: 39;
    /* ниже HUD (40), но выше контента */
}


/* ====== Нижняя шторка (если понадобится) ====== */


/* Нижняя шторка */

.sheet-backdrop {
    position: fixed;
    inset: 0;
    background: var(--bg);
    backdrop-filter: blur(28px);
    z-index: var(--z-bottom-sheet);
}

.sheet-panel {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: calc(var(--z-bottom-sheet) + 1);
    border-top-left-radius: 24px;
    border-top-right-radius: 24px;
    background: var(--card);
    border: 1px solid rgba(255, 255, 255, .08);
    box-shadow: 0 -20px 60px rgba(0, 0, 0, .35);
    /* почти фуллскрин, с учётом iOS динамического вьюпорта */
    max-height: min(92dvh, 92vh);
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: max(env(safe-area-inset-bottom), 12px);
}

.sheet-panel.full {
    top: var(--hud-top);
    /* ← вместо 0 */
    height: calc(100% - var(--hud-top));
    border-radius: 0;
    border: none;
    box-shadow: none;
}

.sheet-handle {
    width: 44px;
    height: 5px;
    border-radius: 999px;
    background: rgba(255, 255, 255, .16);
    margin: 10px auto;
}


/* ====== Верхняя шторка (выпадает из HUD) ====== */

.drop-backdrop {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    /* не перекрываем HUD: начинаем ниже него */
    top: calc(var(--hud-top) + var(--hud-h));
    background: rgba(0, 0, 0, 0.35);
    backdrop-filter: blur(2px);
    z-index: var(--z-top-sheet);
}

.drop-panel {
    position: fixed;
    /* ← важно: fixed */
    left: 0;
    right: 0;
    z-index: calc(var(--z-top-sheet) + 1);
    border-radius: 0;
    /* острые углы */
    background: var(--bg);
    /* единый фон с HUD */
    border: none;
    /* без рамки — есть разделительная полоса */
    box-shadow: none;
    /* без тени */
    overflow: visible;
    /* чтобы стрелка/полоса были видны */
}


/* Полоска‑делитель HUD/шторки со статической стрелкой под нужный пункт */

.drop-divider {
    position: fixed;
    left: 0;
    right: 0;
    height: 14px;
    /* контейнер для линии и треугольника */
    z-index: calc(var(--z-top-sheet) + 3);
    /* поверх всего */
    pointer-events: none;
}

.drop-divider-line {
    position: absolute;
    left: 0;
    right: 0;
    top: 0;
    height: 4px;
    background: #3b454e;
}

.drop-triangle {
    position: absolute;
    top: 4px;
    width: 0;
    height: 0;
    border-left: 12px solid transparent;
    border-right: 12px solid transparent;
    border-bottom: 12px solid #3b454e;
}

.drop-triangle.course {
    left: 28px;
    transform: translateX(-12px);
}

.drop-triangle.streak {
    left: 50%;
    transform: translateX(-12px);
}

.drop-triangle.energy {
    right: 28px;
    transform: translateX(12px);
}


/* три варианта стрелки: курс, стрик, энергия */

.drop-cut {
    position: absolute;
    top: 0;
    width: 0;
    height: 0;
    border-left: 10px solid transparent;
    border-right: 10px solid transparent;
    border-top: none;
    border-bottom: 10px solid var(--bg);
}

.drop-cut.course {
    left: 28px;
    transform: translateX(-10px);
}

.drop-cut.streak {
    left: 50%;
    transform: translate(-10px, 0);
}

.drop-cut.energy {
    right: 28px;
    transform: translate(10px, 0);
}


/* координаты по сетке 4 колонки и паддингу контейнера HUD */

.drop-divider.course::after {
    left: 28px;
}

.drop-divider.streak::after {
    left: 50%;
    transform: translateX(-8px);
}

.drop-divider.energy::after {
    right: 28px;
}


/* маленькая стрелочка-указатель к HUD */

.drop-panel::before {
    content: none;
}


/* ====== Левый сайд-панель (Темы) ====== */

.side-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, .45);
    backdrop-filter: blur(2px);
    z-index: 48;
}

.side-panel {
    position: fixed;
    top: 0;
    bottom: 0;
    left: 0;
    width: 100%;
    max-width: 560px;
    background: var(--bg);
    z-index: 49;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    border-right: 1px solid rgba(255, 255, 255, .08);
}


/* шапка выезжающей слева панели — ниже телеграм-кнопок */

.side-panel-header {
    padding: calc(env(safe-area-inset-top) + 64px) 16px 12px 16px;
    /* было +10 → стало +64 */
    border-bottom: 1px solid rgba(255, 255, 255, .08);
    background: rgba(0, 0, 0, .25);
    backdrop-filter: blur(6px);
}

.side-panel-body {
    padding: 12px 12px max(env(safe-area-inset-bottom), 16px) 12px;
    overflow: auto;
    /* скрыть вертикальную полосу прокрутки, сохранив скролл */
    -ms-overflow-style: none; /* IE/Edge */
    scrollbar-width: none;     /* Firefox */
}
.side-panel-body::-webkit-scrollbar { /* Chrome/Safari */
    display: none;
}


/* ====== Прогресс (энергия) ====== */

.progress {
    height: 14px;
    border-radius: 9999px;
    background: rgba(255, 255, 255, 0.08);
    overflow: hidden;
}

.progress>div {
    height: 100%;
    background: linear-gradient(90deg, #ec4899, #a78bfa);
}


/* ===== кнопка-баннер как у Дуо (wide) ===== */

.topics-hero {
    position: fixed;
    top: calc(var(--hud-top) + var(--hud-h) - 22px);
    left: 12px;
    right: 12px;
    width: auto;
    max-width: none;
    z-index: 39;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    /* визуал */
    height: 80px;
    /* ↑ было 60px, стал выше */
    padding: 14px 18px;
    /* чуть больше внутренние отступы */
    border-radius: 20px;
    border: 1px solid rgba(0, 0, 0, .08);
    background: #306bff;
    /* насыщенный синий (tailwind blue-600) */
    color: #fff;
    box-shadow: 0 10px 28px rgba(0, 0, 0, .35), inset 0 -2px 0 rgba(0, 0, 0, .12);
    backdrop-filter: blur(4px);
}


/* ====== скрыть горизонтальные полосы прокрутки в каруселях ====== */

.no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
}

.no-scrollbar::-webkit-scrollbar {
    display: none;
}

:root {
    color-scheme: dark;
}

html,
body,
#root {
    background-color: var(--bg);
}

body::before {
    content: "";
    position: fixed;
    inset: -20vmax;
    /* перекрыть резиновый bounce */
    background: var(--bg);
    z-index: -1;
}

/* На странице подписки — бесконечный горизонтальный градиент сверху (слева→направо) */
body.subscription-gradient::before {
    background: var(--bg);
}

/* Контейнер для «прогрева» UI во время boot: монтируем реальное дерево, но скрываем */
.prewarm-mount {
    position: fixed;
    inset: 0;
    visibility: hidden;
    pointer-events: none;
    contain: layout style paint;
    z-index: -1;
}
.prewarm-mount * {
    animation: none !important;
    transition: none !important;
}

/* На странице профиля — тянуть фон панели выше верха экрана */
body.profile-overscroll::before {
    background: var(--profile-bg, var(--bg));
}


/* полноэкранный слой под дорогу (но над фоном) */

.decor-layer {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 2;
    /* ниже HUD(40) и баннера(39), но виден сквозь bg-white/5 */
}


/* ярче + лёгкое свечение, но без перегруза GPU */

.decor-item {
    position: absolute;
    color: rgba(255, 255, 255, .28);
    /* было .14 → стало .28 */
    text-shadow: 0 0 10px rgba(255, 255, 255, .10);
    will-change: transform, opacity;
    animation: drift 7s ease-in-out infinite;
    filter: blur(.15px);
}

@keyframes drift {
    0% {
        transform: translate3d(0, 0, 0) rotate(0deg);
        opacity: .22;
    }
    /* было .12 */
    50% {
        transform: translate3d(0, -12px, 0) rotate(3deg);
        opacity: .36;
    }
    /* было .22 */
    100% {
        transform: translate3d(0, 0, 0) rotate(0deg);
        opacity: .22;
    }
}

.decor small {
    opacity: .8;
}

@keyframes blink {
    0%,
    88%,
    100% {
        transform: scaleY(1);
    }
    92% {
        transform: scaleY(0.2);
    }
    96% {
        transform: scaleY(1);
    }
}


/* нижний HUD = та же подложка, что и фон */

.bottomnav {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    /* ← прибито к самому низу */
    background: var(--bg);
    /* фон заливает всё */
    padding-top: 2px;
    z-index: var(--z-hud);
    /* чтобы всегда был над декором, но ниже шторок */
}

/* В AI без подписки — делаем бар белым */
.bottomnav-white {
    background: #f7f7f7 !important;
}
.bottomnav-white .hud-bar * { color: #000 !important; }
.bottomnav-white .bottomnav::before,
.bottomnav-white::before { background: rgba(0,0,0,.08) !important; }


/* когда активен ввод — прячем системный бар телеграма (симулируем) */Ц

.chat-input-active .safe-bottom {
    padding-bottom: calc(max(env(safe-area-inset-bottom), 92px) - 92px);
}


/* ====== Фиксированный ввод чата — чуть выше нижнего HUD ====== */

.ai-input-fixed {
    position: fixed;
    left: 12px;
    right: 12px;
    bottom: calc(max(env(safe-area-inset-bottom), 92px) + 22px);
    z-index: calc(var(--z-hud) + 2);
}


/* Компактные размеры элементов ввода */

.ai-input-row {
    height: 44px;
}

.ai-btn {
    width: 44px;
    height: 44px;
}


/* При фокусе ввода — прижимаем HUD ввода ближе к клавиатуре */

.chat-input-active .ai-input-fixed {
    bottom: calc(env(safe-area-inset-bottom) + 8px);
}


/* Отступ сверху для приветствия под телеграм‑HUD */

.ai-greet-pad {
    padding-top: calc(env(safe-area-inset-top) + var(--ai-greet-h));
}


/* Фиксированный верхний HUD с приветствием на AI */

.ai-greet-hud {
    position: fixed;
    left: 0;
    right: 0;
    top: 0;
    height: calc(env(safe-area-inset-top) + var(--ai-greet-h));
    padding-top: env(safe-area-inset-top);
    background: var(--bg);
    border-bottom: 1px solid rgba(255, 255, 255, .1);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: calc(var(--z-hud) + 1);
}


/* затемнение/скрытие нижнего HUD, когда фокус в поле ввода */

.chat-input-active .bottomnav {
    display: none;
}


/* точки «печатает» */

.typing-dot {
    width: 10px;
    height: 10px;
    border-radius: 9999px;
    background: #fff;
    display: inline-block;
    animation: typingJump 1s ease-in-out infinite;
}

.typing-dot:nth-child(2) {
    animation-delay: .15s;
}

.typing-dot:nth-child(3) {
    animation-delay: .3s;
}

@keyframes typingJump {
    0%,
    60%,
    100% {
        transform: translateY(0);
        opacity: .85;
    }
    30% {
        transform: translateY(-6px);
        opacity: 1;
    }
}


/* разделительная полоска теперь тоже выше */


/* разделительная полоска — в самом верху контейнера */

.bottomnav::before {
    content: "";
    position: absolute;
    left: 0;
    right: 0;
    top: 0;
    /* ← линия ровно по верхней кромке bottomnav */
    height: 2px;
    background: rgba(255, 255, 255, .12);
    pointer-events: none;
}


/* сам бар без «карточности» — фон берём из .bottomnav */

.hud-bar {
    background: transparent;
    /* ← убираем локальный фон, он теперь у .bottomnav */
    backdrop-filter: none;
    border: none;
    box-shadow: none;
    border-radius: 0;
    margin-left: 14px;
    margin-right: 14px;
    /* узкий бар: не до краёв */
}

.bottomnav a .active-ring {
    opacity: 0;
}


/* базовое состояние — скрыта */


/* унифицированная рамка активного таба для всех иконок */

.bottomnav a .active-ring {
    opacity: 0;
    top: 5px;
    bottom: 5px;
    left: 3px;
    right: 3px;
    border-radius: 12px;
}

.bottomnav a[aria-current="page"] .active-ring {
    opacity: 1;
}


/* больше воздуха у краёв экрана */

.bottomnav .hud-bar {
    margin-left: 14px;
    /* подбери 12–20px по вкусу */
    margin-right: 14px;
}


/* ====== Запрет выделения текста и callout ====== */

* {
    -webkit-user-select: none;          /* Safari / iOS */
    -moz-user-select: none;             /* Firefox */
    -ms-user-select: none;              /* IE/Edge */
    user-select: none;                  /* Современные браузеры */
    -webkit-touch-callout: none;        /* Убирает контекстное меню iOS */
}

/* Разрешаем нормальную работу ввода/копирования там, где это нужно */
input,
textarea,
[contenteditable="true"],
.allow-select,
.allow-select *,
.prose,
.prose *,
pre,
code {
    -webkit-user-select: text !important;
    -moz-user-select: text !important;
    -ms-user-select: text !important;
    user-select: text !important;
    -webkit-touch-callout: default !important;
}

/* Снижаем вероятность двойного тапа-зумма на интерактивах (iOS Safari) */
button,
a,
[role="button"],
.btn,
.ai-btn {
    touch-action: manipulation;
}

/* Не даём перетаскивать изображения (iOS Safari жест long-press) */
img,
svg {
    -webkit-user-drag: none;
}


/* Разрешить выделение/копирование только для GPT-текста в AI */

/* allow-select оставлен для совместимости со старыми узлами */

/* Markdown/KaTeX tweaks */
.prose code {
    @apply rounded px-1.5 py-0.5 bg-white/10 border border-white/10;
}
.prose pre code {
    @apply bg-transparent border-0 px-0 py-0;
}
.prose table {
    @apply w-full overflow-auto block my-3;
}
.prose thead th {
    @apply border-b border-white/20;
}
.prose tbody td {
    @apply border-b border-white/10;
}
.katex-display {
    overflow-x: auto;
}